<?xml version="1.0" encoding="UTF-8"?>

<?include "cpack_variables.wxi"?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
    RequiredVersion="3.6.3303.0">

    <Product Id="$(var.CPACK_WIX_PRODUCT_GUID)"
        Name="$(var.CPACK_PACKAGE_NAME)"
        Language="1033"
        Version="$(var.CPACK_PACKAGE_VERSION)"
        Manufacturer="$(var.CPACK_PACKAGE_VENDOR)"
        UpgradeCode="$(var.CPACK_WIX_UPGRADE_GUID)">

        <Package InstallerVersion="301" Compressed="yes"/>

        <Media Id="1" Cabinet="media1.cab" EmbedCab="yes"/>

        <MajorUpgrade
            Schedule="afterInstallInitialize"
            AllowSameVersionUpgrades="yes"
            DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit."/>

        <WixVariable Id="WixUILicenseRtf" Value="$(var.CPACK_WIX_LICENSE_RTF)"/>
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALL_ROOT"/>

        <Property Id="VIDEO_RESOLUTION"/>
        <Property Id="MOD_EXISTS" Value="0"/>
        <Property Id="SHOULD_OPEN_CONFIG"/>

        <CustomAction Id="CheckModExists" Script="vbscript"><![CDATA[
            Dim fso
            Set fso = CreateObject("Scripting.FileSystemObject")
            If (fso.FileExists(Session.Property("INSTALL_ROOT") & "d3d9.dll")) Then
                Session.Property("MOD_EXISTS") = "1"
            Else
                Session.Property("MOD_EXISTS") = "0"
            End If
        ]]></CustomAction>

        <?ifdef CPACK_WIX_PRODUCT_ICON?>
        <Property Id="ARPPRODUCTICON">ProductIcon.ico</Property>
        <Icon Id="ProductIcon.ico" SourceFile="$(var.CPACK_WIX_PRODUCT_ICON)"/>
        <?endif?>

        <?ifdef CPACK_WIX_UI_BANNER?>
        <WixVariable Id="WixUIBannerBmp" Value="$(var.CPACK_WIX_UI_BANNER)"/>
        <?endif?>

        <?ifdef CPACK_WIX_UI_DIALOG?>
        <WixVariable Id="WixUIDialogBmp" Value="$(var.CPACK_WIX_UI_DIALOG)"/>
        <?endif?>

        <FeatureRef Id="ProductFeature"/>

        <UIRef Id="CustomInstallDir" />

        <?include "properties.wxi"?>
        <?include "product_fragment.wxi"?>

        <Property Id="GAME_INSTALL_ROOT" Secure="yes">
            <RegistrySearch Id="FindGameInstallLocation" Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Steam App 311730" Name="InstallLocation" Type="raw" Win64="yes"/>
        </Property>
        <SetProperty Id="INSTALL_ROOT" Value="[GAME_INSTALL_ROOT]" Before="CostFinalize"/>

        <Property Id="WixShellExecTarget" Value="[INSTALL_ROOT]mod_resolution.ini" />
        <CustomAction Id="OpenConfig" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />
    </Product>
</Wix>
